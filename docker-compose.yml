services:
  db:
    image: postgres:15-alpine
    container_name: flight_claim_db
    environment:
      POSTGRES_DB: flight_claim
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    stop_grace_period: 60s
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nextcloud_network

  redis:
    image: redis:7-alpine
    container_name: flight_claim_redis
    command: redis-server --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD must be set}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nextcloud_network

  clamav:
    image: clamav/clamav:latest
    container_name: flight_claim_clamav
    ports:
      - "3310:3310"
    environment:
      # Keep database updated
      CLAMAV_NO_FRESHCLAM: "false"
    healthcheck:
      test: ["CMD", "clamdscan", "--ping", "127.0.0.1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    # Limit memory usage as ClamAV can be hungry
    deploy:
      resources:
        limits:
          memory: 2G
    networks:
      - nextcloud_network

  api:
    # image: claimplane-api:hotfix
    build: .
    container_name: flight_claim_api
    environment:
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL must be set}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      SECRET_KEY: ${SECRET_KEY:?SECRET_KEY must be set}
      FILE_ENCRYPTION_KEY: ${FILE_ENCRYPTION_KEY:?FILE_ENCRYPTION_KEY must be set}
      DB_ENCRYPTION_KEY: ${DB_ENCRYPTION_KEY:?DB_ENCRYPTION_KEY must be set}
      NEXTCLOUD_URL: ${NEXTCLOUD_URL:-http://nextcloud:80}
      NEXTCLOUD_USERNAME: ${NEXTCLOUD_USERNAME:-admin}
      NEXTCLOUD_PASSWORD: ${NEXTCLOUD_PASSWORD:?NEXTCLOUD_PASSWORD must be set}
      REDIS_URL: ${REDIS_URL:?REDIS_URL must be set}
      VIRUS_SCAN_ENABLED: ${VIRUS_SCAN_ENABLED:-true}
      CLAMAV_URL: ${CLAMAV_URL:-flight_claim_clamav:3310}
      RATE_LIMIT_UPLOAD: ${RATE_LIMIT_UPLOAD:-100/minute}
      RATE_LIMIT_DOWNLOAD: ${RATE_LIMIT_DOWNLOAD:-1000/minute}
      JWT_EXPIRATION_MINUTES: ${JWT_EXPIRATION_MINUTES:-30}
      JWT_REFRESH_EXPIRATION_DAYS: ${JWT_REFRESH_EXPIRATION_DAYS:-7}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:3001,http://localhost:3002,http://localhost:3003,http://localhost:8081,https://eac.dvvcloud.work}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,127.0.0.1,eac.dvvcloud.work,api}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      API_VERSION: ${API_VERSION:-1.0.0}
      API_TITLE: ${API_TITLE:-Flight Claim System API}
      SECURITY_HEADERS_ENABLED: ${SECURITY_HEADERS_ENABLED:-false}
      FILE_RETENTION_DAYS: ${FILE_RETENTION_DAYS:-365}
      NEXTCLOUD_TIMEOUT: ${NEXTCLOUD_TIMEOUT:-30}
      NEXTCLOUD_MAX_RETRIES: ${NEXTCLOUD_MAX_RETRIES:-3}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-noreply@flightclaim.com}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Flight Claim System}
      SMTP_USE_TLS: ${SMTP_USE_TLS:-true}
      NOTIFICATIONS_ENABLED: ${NOTIFICATIONS_ENABLED:-true}
      FRONTEND_URL: ${FRONTEND_URL:-https://eac.dvvcloud.work}
      AERODATABOX_API_KEY: ${AERODATABOX_API_KEY}
      AERODATABOX_BASE_URL: ${AERODATABOX_BASE_URL:-https://aerodatabox.p.rapidapi.com/v1}
      AERODATABOX_TIMEOUT: ${AERODATABOX_TIMEOUT:-30}
      AERODATABOX_MAX_RETRIES: ${AERODATABOX_MAX_RETRIES:-3}
      AERODATABOX_ENABLED: ${AERODATABOX_ENABLED:-false}
      AERODATABOX_MONTHLY_QUOTA: ${AERODATABOX_MONTHLY_QUOTA:-600}
      AERODATABOX_ALERT_THRESHOLD: ${AERODATABOX_ALERT_THRESHOLD:-80}
      FLIGHT_SEARCH_ENABLED: ${FLIGHT_SEARCH_ENABLED:-true}
      FLIGHT_SEARCH_PROVIDER: ${FLIGHT_SEARCH_PROVIDER:-aerodatabox}
      FLIGHT_SEARCH_MAX_RESULTS: ${FLIGHT_SEARCH_MAX_RESULTS:-50}
      FLIGHT_SEARCH_CACHE_HOURS: ${FLIGHT_SEARCH_CACHE_HOURS:-24}
      AIRPORT_AUTOCOMPLETE_CACHE_DAYS: ${AIRPORT_AUTOCOMPLETE_CACHE_DAYS:-7}
      FLIGHT_SEARCH_ANALYTICS_ENABLED: ${FLIGHT_SEARCH_ANALYTICS_ENABLED:-true}
      GOOGLE_APPLICATION_CREDENTIALS: /app/google-cloud-key.json
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      GOOGLE_CLOUD_LOCATION: ${GOOGLE_CLOUD_LOCATION}
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./app:/app/app
      - ./google-cloud-key.json:/app/google-cloud-key.json:ro
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - nextcloud_network

  celery_worker:
    build: .
    container_name: flight_claim_celery_worker
    environment:
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL must be set}
      REDIS_URL: ${REDIS_URL:?REDIS_URL must be set}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      SECRET_KEY: ${SECRET_KEY:?SECRET_KEY must be set}
      FILE_ENCRYPTION_KEY: ${FILE_ENCRYPTION_KEY:?FILE_ENCRYPTION_KEY must be set}
      DB_ENCRYPTION_KEY: ${DB_ENCRYPTION_KEY:?DB_ENCRYPTION_KEY must be set}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-noreply@flightclaim.com}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Flight Claim System}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      FRONTEND_URL: ${FRONTEND_URL:-https://eac.dvvcloud.work}
      GOOGLE_APPLICATION_CREDENTIALS: /app/google-cloud-key.json
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      GOOGLE_CLOUD_LOCATION: ${GOOGLE_CLOUD_LOCATION}
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
    volumes:
      - ./app:/app/app
      - ./google-cloud-key.json:/app/google-cloud-key.json:ro
    command: celery -A app.celery_app worker --loglevel=info
    networks:
      - nextcloud_network

  celery_beat:
    build: .
    container_name: flight_claim_celery_beat
    environment:
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL must be set}
      REDIS_URL: ${REDIS_URL:?REDIS_URL must be set}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      SECRET_KEY: ${SECRET_KEY:?SECRET_KEY must be set}
      FILE_ENCRYPTION_KEY: ${FILE_ENCRYPTION_KEY:?FILE_ENCRYPTION_KEY must be set}
      DB_ENCRYPTION_KEY: ${DB_ENCRYPTION_KEY:?DB_ENCRYPTION_KEY must be set}
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-noreply@flightclaim.com}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Flight Claim System}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      FRONTEND_URL: ${FRONTEND_URL:-https://eac.dvvcloud.work}
      GOOGLE_APPLICATION_CREDENTIALS: /app/google-cloud-key.json
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      GOOGLE_CLOUD_LOCATION: ${GOOGLE_CLOUD_LOCATION}
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
    volumes:
      - ./app:/app/app
      - ./google-cloud-key.json:/app/google-cloud-key.json:ro
    command: celery -A app.celery_app beat --loglevel=info
    networks:
      - nextcloud_network

  nginx:
    image: nginx:alpine
    container_name: flight_claim_nginx
    ports:
      - "80:80"
    depends_on:
      - api
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend_Claude45/dist:/var/www/claimplane:ro
    networks:
      - nextcloud_network

  webhook:
    build:
      context: .
      dockerfile: Dockerfile.webhook
      args:
        DOCKER_GID: ${DOCKER_GID:-988}
    container_name: flight_claim_webhook
    environment:
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:?WEBHOOK_SECRET must be set}
      WEBHOOK_PORT: 9000
    ports:
      - "9000:9000"
    volumes:
      # Mount project directory for git operations
      - .:/home/david/easyAirClaim/claimplane
      # Mount Docker socket to run docker-compose commands
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount webhook scripts
      - ./webhook_deploy.py:/app/webhook_deploy.py:ro
      - ./deploy.sh:/app/deploy.sh:ro
    restart: always
    networks:
      - nextcloud_network

networks:
  nextcloud_network:
    external: true
    name: claimplane_nextcloud_network

volumes:
 postgres_data: